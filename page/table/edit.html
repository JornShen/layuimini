<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <style>
        body {
            background-color: #ffffff;
        }
    </style>
</head>
<body>
<div class="layui-form layuimini-form">
    <div class="layui-form-item">
        <label class="layui-form-label">队名：</label>
        <div class="layui-form-label-col" data-value="XXX" id="team_name">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">队长：</label>
        <div class="layui-form-label-col" data-value="XXX" id="captain">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">项目名称：</label>
        <div class="layui-form-label-col" data-value="XXX" id="project_name">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">项目描述：</label>
        <div class="layui-form-label-col" data-value="XXX" id="project_description">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">当前队员：</label>
        <div class="layui-form-label-col" id="team_mate">
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBtn">确认加入</button>
        </div>
    </div>
</div>
</div>
<script src="../../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script>
    function getQueryVariable(variable){
        let query = window.location.search.substring(1);
        let vars = query.split("&");
        for (let i=0;i<vars.length;i++) {
            let pair = vars[i].split("=");
            if(pair[0] == variable){return pair[1];}
        }
        return(false);
    }

    function getQueryVariableFromParent(variable){
        let query = window.parent.location.search.substring(1);
        let vars = query.split("&");
        for (let i=0;i<vars.length;i++) {
            let pair = vars[i].split("=");
            if(pair[0] == variable){return pair[1];}
        }
        return(false);
    }

    layui.use(['form', 'jquery'], function () {
        var form = layui.form,
            layer = layui.layer,
            $ = layui.jquery;

        var id = getQueryVariable("id");
        var accountId = getQueryVariableFromParent("accountId")
        var team_name, project_name, captain, project_decription
        var team_mate = ""
        $.ajax({
            url: "http://180.184.70.75:8080/team?id="+id,
            type: 'get',
            success: function(result) {
                console.log("get team success", result)
                team_name =  result.name
                project_name = result.project_name
                project_decription = result.description
                console.log(team_name, project_name, project_decription)
                $("#team_name").text(team_name)
                $("#project_name").text(project_name)
                $("#project_description").text(project_decription)
            },
            error: function(result) {
                console.log("get team error ")
            }
        });

        $.ajax({
            url: "http://180.184.70.75:8080/personList?team_id?" + id,
            type: 'get',
            success: function(result) {
                console.log("get personlist success", result)
                for (i = 0; i < result.length; i++) {
                    if (result[i].role == 1) {
                        captain = result[i].name
                    } else {
                        if (team_mate == "") {
                            team_mate = result[i].name
                        } else {
                            team_mate = team_mate + "," + result[i].name
                        }
                    }
                }
                $("#captain").text(captain)
                $("#team_mate").text(team_mate)
                console.log(captain, team_mate)
            },
            error: function(result) {
                console.log("get person error ")
            }
        });

        //监听提交
        form.on('submit(saveBtn)', function (data) {
            var index = layer.alert("确定提交?", {
                title: '提示'
            }, function () {
                layer.close(index);
                var iframeIndex = parent.layer.getFrameIndex(window.name);
                parent.layer.close(iframeIndex);

                $.ajax({
                    url: "http://180.184.70.75:8080/updatePerson",
                    type: 'post',
                    dataType: 'json',
                    data: JSON.stringify({
                        id: parseInt(accountId),
                        role: parseInt("2"),
                        team_id: parseInt(id),
                    }),
                    success: function(result) {
                        alert("success")
                        console.log("update people success")
                        // 关闭弹出层
                        return true
                    },
                    error: function () {
                        alert("error")
                        console.log("error")
                        return false
                    }
                });
            });
        });

    });
</script>
</body>
</html>